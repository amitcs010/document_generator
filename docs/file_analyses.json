[
  {
    "purpose": "Updates or inserts customer lifetime value and order count into a dedicated scores table based on sales order data.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.customer_scores"
    ],
    "transformations": [
      "Calculates lifetime_value by summing order_amount for each customer.",
      "Calculates order_count by counting orders for each customer.",
      "Upserts (MERGE) the aggregated customer scores into the target table, updating existing records or inserting new ones."
    ],
    "business_logic": "Customer lifetime value and total order count are aggregated from sales transactions and maintained in a customer scores table for analytics.",
    "dependencies": [
      "analytics.sales_orders",
      "analytics.customer_scores"
    ],
    "file_name": "sp_update_customer_scores.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_update_customer_scores.sql"
  },
  {
    "purpose": "Refreshes the `analytics.daily_sales` table by truncating its current data and reloading it with sales order information, including a calculated order amount.",
    "source_tables": [
      "staging.sales_orders"
    ],
    "target_tables": [
      "analytics.daily_sales"
    ],
    "transformations": [
      "Calculates `order_amount` by multiplying `quantity` and `price`"
    ],
    "business_logic": "Daily sales data is completely overwritten with fresh sales order details and their calculated total amounts from the staging area.",
    "dependencies": [
      "analytics.daily_sales (table)",
      "staging.sales_orders (table)"
    ],
    "file_name": "sp_refresh_daily_sales.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_refresh_daily_sales.sql"
  },
  {
    "purpose": "This SQL creates an enriched sales order dataset by joining raw order details with product dimensions and calculating the total order amount.",
    "source_tables": [
      "raw.orders",
      "dim_products"
    ],
    "target_tables": [
      "sales_orders"
    ],
    "transformations": [
      "Joins raw order data with product lookup information based on product_id",
      "Calculates the 'order_amount' by multiplying quantity and price"
    ],
    "business_logic": "Combines transactional order data with static product attributes and computes the total value for each order line item.",
    "dependencies": [
      "raw.orders",
      "dim_products"
    ],
    "file_name": "sales_orders.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/sales_orders.sql"
  },
  {
    "purpose": "Creates a dimension table for products by selecting key attributes from the raw products source.",
    "source_tables": [
      "raw.products"
    ],
    "target_tables": [
      "dim_products"
    ],
    "transformations": [
      "Column selection"
    ],
    "business_logic": "Extracts core product attributes directly from the raw data for use in a dimension model.",
    "dependencies": [
      "raw.products"
    ],
    "file_name": "dim_products.sql",
    "file_type": "model",
    "file_path": "sql/dbt_models/dim_products.sql"
  },
  {
    "purpose": "Creates a summary table consolidating customer demographic details with their total revenue and order count.",
    "source_tables": [
      "sales_orders",
      "raw.customers"
    ],
    "target_tables": [
      "customer_summary"
    ],
    "transformations": [
      "Aggregates sales orders to calculate total revenue (SUM(quantity * price)) per customer.",
      "Counts total orders per customer (COUNT(*)).",
      "Joins customer attributes with aggregated order data using customer_id.",
      "Ensures all customers are included using a LEFT JOIN."
    ],
    "business_logic": "Each customer's total revenue is calculated by summing the product of quantity and price across all their sales orders, and their total orders count is the number of individual order entries, with all customer details preserved even if they have no associated orders.",
    "dependencies": [
      "sales_orders",
      "raw.customers"
    ],
    "file_name": "customer_summary.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/customer_summary.sql"
  },
  {
    "purpose": "Identifies top customers based on their total spending exceeding a specified threshold.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.vw_top_customers"
    ],
    "transformations": [
      "Aggregates order amounts by customer",
      "Filters customers based on total spend"
    ],
    "business_logic": "A customer is considered a 'top customer' if their total order amount is greater than 10000.",
    "dependencies": [
      "analytics.sales_orders"
    ],
    "file_name": "vw_top_customers.sql",
    "file_type": "view",
    "file_path": "sql/views/vw_top_customers.sql"
  },
  {
    "purpose": "Creates or replaces a cleaned sales staging table by selecting and transforming data from the raw sales table.",
    "source_tables": [
      "raw.sales"
    ],
    "target_tables": [
      "staging.sales_clean"
    ],
    "transformations": [
      "Casting order_date to DATE with TRY_CAST for error handling",
      "Casting price to NUMBER(10,2) with TRY_CAST for error handling",
      "Filtering out records where order_id is NULL",
      "Filtering out records where quantity is not greater than 0"
    ],
    "business_logic": "Only includes valid sales records with a defined order ID and a positive quantity, ensuring date and price fields are properly formatted.",
    "dependencies": [
      "raw.sales table"
    ],
    "file_name": "ctas_create_sales_clean.sql",
    "file_type": "script",
    "file_path": "sql/etl/ctas_create_sales_clean.sql"
  },
  {
    "purpose": "This SQL script enriches raw order data by joining it with customer and product information and calculating the total order amount.",
    "source_tables": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "target_tables": [],
    "transformations": [
      "Performs LEFT JOINs between orders, customers, and products tables.",
      "Calculates 'order_amount' by multiplying 'quantity' and 'price' for each order."
    ],
    "business_logic": "Combines raw transactional order details with customer demographic data (region) and product descriptive data (category, product name) to create a comprehensive view of each sale, including its total monetary value.",
    "dependencies": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "file_name": "sales_enriched_pipeline.sql",
    "file_type": "script",
    "file_path": "sql/etl/sales_enriched_pipeline.sql"
  }
]