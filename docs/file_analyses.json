[
  {
    "purpose": "Updates or inserts customer lifetime value and total order count based on sales order data into a customer scores table.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.customer_scores"
    ],
    "transformations": [
      "Calculates lifetime_value by summing order_amount per customer_id.",
      "Calculates order_count by counting orders per customer_id.",
      "Performs a MERGE operation to update existing customer scores or insert new ones."
    ],
    "business_logic": "Maintains an up-to-date record of each customer's lifetime value and total order count in the analytics.customer_scores table.",
    "dependencies": [
      "analytics.sales_orders",
      "analytics.customer_scores"
    ],
    "file_name": "sp_update_customer_scores.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_update_customer_scores.sql"
  },
  {
    "purpose": "Refreshes the analytics.daily_sales table by clearing its existing data and loading new sales records from staging.",
    "source_tables": [
      "staging.sales_orders"
    ],
    "target_tables": [
      "analytics.daily_sales"
    ],
    "transformations": [
      "Calculate order_amount as quantity * price"
    ],
    "business_logic": "Ensures the analytics.daily_sales table contains up-to-date sales data, including a calculated total for each order from the staging area.",
    "dependencies": [
      "staging.sales_orders",
      "analytics.daily_sales"
    ],
    "file_name": "sp_refresh_daily_sales.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_refresh_daily_sales.sql"
  },
  {
    "purpose": "Creates an incremental table of sales orders by combining raw order data with product dimension details and calculating the order amount.",
    "source_tables": [
      "raw.orders",
      "dim_products"
    ],
    "target_tables": [
      "sales_orders"
    ],
    "transformations": [
      "Calculates order_amount as quantity * price",
      "Enriches order data with product category and sub_category via a LEFT JOIN",
      "Materialized incrementally based on order_id as unique key"
    ],
    "business_logic": "Combines transactional sales order details with corresponding product information to provide a comprehensive view of each order item, including its total amount.",
    "dependencies": [
      "source('raw', 'orders')",
      "ref('dim_products')"
    ],
    "file_name": "sales_orders.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/sales_orders.sql"
  },
  {
    "purpose": "Creates a product dimension table by selecting key attributes from a raw products source.",
    "source_tables": [
      "raw.products"
    ],
    "target_tables": [
      "dim_products"
    ],
    "transformations": [
      "Direct column selection from source table",
      "Materializes the result as a table"
    ],
    "business_logic": "Establishes a curated list of product attributes for use in downstream analytical models.",
    "dependencies": [
      "source:raw.products"
    ],
    "file_name": "dim_products.sql",
    "file_type": "model",
    "file_path": "sql/dbt_models/dim_products.sql"
  },
  {
    "purpose": "Generates a summary table of customer details including their total revenue and order count.",
    "source_tables": [
      "sales_orders",
      "raw.customers"
    ],
    "target_tables": [
      "customer_summary"
    ],
    "transformations": [
      "Aggregates sales order data by customer to calculate total revenue and total orders",
      "Joins customer demographic information with aggregated order statistics"
    ],
    "business_logic": "Calculates the total revenue and total number of orders for each customer and combines this with their first name, last name, and region.",
    "dependencies": [
      "sales_orders",
      "raw.customers"
    ],
    "file_name": "customer_summary.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/customer_summary.sql"
  },
  {
    "purpose": "This SQL view identifies customers whose total spending exceeds a specific threshold.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.vw_top_customers"
    ],
    "transformations": [
      "Aggregates order amounts by customer",
      "Filters customers based on total spend threshold"
    ],
    "business_logic": "Customers are considered 'top customers' if their cumulative spending across all orders is greater than 10,000.",
    "dependencies": [
      "analytics.sales_orders"
    ],
    "file_name": "vw_top_customers.sql",
    "file_type": "view",
    "file_path": "sql/views/vw_top_customers.sql"
  },
  {
    "purpose": "This SQL script creates or replaces a cleaned sales table in the staging schema, deriving it from the raw sales data.",
    "source_tables": [
      "raw.sales"
    ],
    "target_tables": [
      "staging.sales_clean"
    ],
    "transformations": [
      "Casting 'order_date' to DATE, handling potential errors gracefully.",
      "Casting 'price' to NUMBER(10,2), handling potential errors gracefully.",
      "Filtering out records where 'order_id' is null.",
      "Filtering out records where 'quantity' is not positive."
    ],
    "business_logic": "It selects valid sales records by ensuring a non-null order ID and a positive quantity, while standardizing the data types for order date and price.",
    "dependencies": [
      "raw.sales"
    ],
    "file_name": "ctas_create_sales_clean.sql",
    "file_type": "script",
    "file_path": "sql/etl/ctas_create_sales_clean.sql"
  },
  {
    "purpose": "This SQL enriches raw order data by joining it with customer and product details and calculating the total order amount per item.",
    "source_tables": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "target_tables": [],
    "transformations": [
      "Joins raw orders with customer and product data using LEFT JOINs",
      "Calculates 'order_amount' by multiplying quantity and price",
      "Selects specific attributes from joined tables including region, category, and product name"
    ],
    "business_logic": "Enriches individual order line items with customer region, product category and name, and calculates the total sales value for each item.",
    "dependencies": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "file_name": "sales_enriched_pipeline.sql",
    "file_type": "script",
    "file_path": "sql/etl/sales_enriched_pipeline.sql"
  }
]