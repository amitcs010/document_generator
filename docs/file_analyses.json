[
  {
    "purpose": "This procedure updates or inserts customer lifetime value and order count into the customer_scores table based on sales order data.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.customer_scores"
    ],
    "transformations": [
      "Calculates lifetime_value by summing order_amount per customer.",
      "Calculates order_count by counting orders per customer.",
      "Performs an upsert (MERGE) operation to update existing customer scores or insert new ones."
    ],
    "business_logic": "It calculates each customer's total sales amount (lifetime value) and total number of orders from sales data and maintains this information in a dedicated customer scores table.",
    "dependencies": [
      "analytics.customer_scores",
      "analytics.sales_orders"
    ],
    "file_name": "sp_update_customer_scores.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_update_customer_scores.sql"
  },
  {
    "purpose": "This procedure truncates and reloads the daily_sales table in the analytics schema from the staging.sales_orders table.",
    "source_tables": [
      "staging.sales_orders"
    ],
    "target_tables": [
      "analytics.daily_sales"
    ],
    "transformations": [
      "Calculates order_amount as the product of quantity and price",
      "Completely overwrites the target table using TRUNCATE before INSERT"
    ],
    "business_logic": "Individual order item amounts are calculated as the product of quantity and price to determine total sales value.",
    "dependencies": [
      "analytics.daily_sales",
      "staging.sales_orders"
    ],
    "file_name": "sp_refresh_daily_sales.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_refresh_daily_sales.sql"
  },
  {
    "purpose": "Creates an enhanced sales orders dataset by combining raw order details with product dimension information and calculating the total order amount.",
    "source_tables": [
      "raw.orders",
      "dim_products"
    ],
    "target_tables": [
      "sales_orders"
    ],
    "transformations": [
      "Calculates 'order_amount' by multiplying 'quantity' and 'price'",
      "Joins raw order data with product lookup data on 'product_id'",
      "Selects specific attributes from both sources including product category and sub-category"
    ],
    "business_logic": "Enriches individual sales order records by integrating product classification details and computing the financial value for each order line item.",
    "dependencies": [
      "source('raw', 'orders')",
      "ref('dim_products')"
    ],
    "file_name": "sales_orders.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/sales_orders.sql"
  },
  {
    "purpose": "This SQL creates a dimension table for products by selecting key product attributes from a raw source table.",
    "source_tables": [
      "raw.products"
    ],
    "target_tables": [
      "dim_products"
    ],
    "transformations": [
      "Column selection"
    ],
    "business_logic": "Extracts core product information to form a dimensional model for analytical purposes.",
    "dependencies": [
      "raw.products"
    ],
    "file_name": "dim_products.sql",
    "file_type": "model",
    "file_path": "sql/dbt_models/dim_products.sql"
  },
  {
    "purpose": "This SQL script creates a customer summary table by combining customer details with their aggregated order statistics.",
    "source_tables": [
      "sales_orders",
      "raw.customers"
    ],
    "target_tables": [
      "customer_summary"
    ],
    "transformations": [
      "Aggregates total revenue and total orders for each customer from sales_orders",
      "Joins customer demographic data with aggregated order statistics on customer_id"
    ],
    "business_logic": "Combines customer personal information with their total purchasing activity (revenue and order count) to provide a comprehensive customer profile.",
    "dependencies": [
      "sales_orders",
      "raw.customers"
    ],
    "file_name": "customer_summary.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/customer_summary.sql"
  },
  {
    "purpose": "Creates a view that identifies and lists customers whose total spending in sales orders exceeds $10,000.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.vw_top_customers"
    ],
    "transformations": [
      "Aggregates the sum of order amounts per customer",
      "Filters customers based on a cumulative spend threshold"
    ],
    "business_logic": "Defines 'top customers' as those whose total order amount across all sales orders is greater than $10,000.",
    "dependencies": [
      "analytics.sales_orders"
    ],
    "file_name": "vw_top_customers.sql",
    "file_type": "view",
    "file_path": "sql/views/vw_top_customers.sql"
  },
  {
    "purpose": "This SQL script creates or replaces the `staging.sales_clean` table by cleaning and transforming sales data from the `raw.sales` table.",
    "source_tables": [
      "raw.sales"
    ],
    "target_tables": [
      "staging.sales_clean"
    ],
    "transformations": [
      "Casting 'order_date' to DATE using TRY_CAST for error handling.",
      "Casting 'price' to NUMBER(10,2) using TRY_CAST for error handling.",
      "Filtering out records where 'order_id' is NULL.",
      "Filtering out records where 'quantity' is not greater than 0."
    ],
    "business_logic": "It ensures that only valid sales records with a positive quantity and a non-null order ID are staged, with standardized data types for date and price.",
    "dependencies": [
      "raw.sales"
    ],
    "file_name": "ctas_create_sales_clean.sql",
    "file_type": "script",
    "file_path": "sql/etl/ctas_create_sales_clean.sql"
  },
  {
    "purpose": "Joins order, customer, and product data to create an enriched sales dataset, calculating the total amount for each order.",
    "source_tables": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "target_tables": [],
    "transformations": [
      "Join orders with customers and products on their respective IDs",
      "Calculate order_amount as the product of quantity and price",
      "Enrich order details with customer region, product category, and product name"
    ],
    "business_logic": "Enriches raw order transactions with customer and product master data attributes, and computes the extended price for each order line item.",
    "dependencies": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "file_name": "sales_enriched_pipeline.sql",
    "file_type": "script",
    "file_path": "sql/etl/sales_enriched_pipeline.sql"
  }
]