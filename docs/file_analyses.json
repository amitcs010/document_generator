[
  {
    "purpose": "Updates or inserts customer lifetime value and order count metrics into a dedicated customer scores table.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.customer_scores"
    ],
    "transformations": [
      "Calculates lifetime_value by summing order_amount for each customer.",
      "Calculates order_count by counting orders for each customer.",
      "Aggregates sales data by customer_id.",
      "Performs an upsert (update if customer_id matches, insert if not) into the customer_scores table."
    ],
    "business_logic": "Determine each customer's total spending and total number of orders from sales data to maintain an up-to-date customer profile in the scores table.",
    "dependencies": [
      "analytics.sales_orders",
      "analytics.customer_scores"
    ],
    "file_name": "sp_update_customer_scores.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_update_customer_scores.sql"
  },
  {
    "purpose": "Refreshes the `analytics.daily_sales` table by truncating existing data and reloading it from `staging.sales_orders`.",
    "source_tables": [
      "staging.sales_orders"
    ],
    "target_tables": [
      "analytics.daily_sales"
    ],
    "transformations": [
      "Calculates `order_amount` by multiplying `quantity` and `price`"
    ],
    "business_logic": "The daily sales data in the analytics layer is completely rebuilt based on current sales orders from the staging area, including a calculated total order amount for each line item.",
    "dependencies": [
      "analytics.daily_sales",
      "staging.sales_orders"
    ],
    "file_name": "sp_refresh_daily_sales.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_refresh_daily_sales.sql"
  },
  {
    "purpose": "Enriches raw sales order data with product details and calculates the total order amount.",
    "source_tables": [
      "raw.orders",
      "dim_products"
    ],
    "target_tables": [
      "sales_orders"
    ],
    "transformations": [
      "Joins raw order data with product dimensions",
      "Calculates order_amount as quantity multiplied by price"
    ],
    "business_logic": "Raw orders are joined with product information to categorize sales and calculate the total value for each order line item.",
    "dependencies": [
      "raw.orders",
      "dim_products"
    ],
    "file_name": "sales_orders.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/sales_orders.sql"
  },
  {
    "purpose": "Creates a dimension table named dim_products by selecting specific product attributes from the raw products source table.",
    "source_tables": [
      "raw.products"
    ],
    "target_tables": [
      "dim_products"
    ],
    "transformations": [
      "Direct column selection/projection from the source table."
    ],
    "business_logic": "Defines the core product attributes for analytical use as a dimension table.",
    "dependencies": [
      "raw.products"
    ],
    "file_name": "dim_products.sql",
    "file_type": "model",
    "file_path": "sql/dbt_models/dim_products.sql"
  },
  {
    "purpose": "This SQL script creates a comprehensive summary of customer details, including their total revenue and total number of orders.",
    "source_tables": [
      "sales_orders",
      "raw.customers"
    ],
    "target_tables": [
      "customer_summary"
    ],
    "transformations": [
      "Aggregates sales data to calculate total revenue and total orders per customer.",
      "Joins customer demographic details with their aggregated order statistics based on customer_id."
    ],
    "business_logic": "Combines basic customer information with their purchasing history to provide a unified customer profile, including those customers without any orders.",
    "dependencies": [
      "sales_orders",
      "raw.customers"
    ],
    "file_name": "customer_summary.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/customer_summary.sql"
  },
  {
    "purpose": "This SQL creates a view that identifies customers who have spent more than 10,000.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.vw_top_customers"
    ],
    "transformations": [
      "Aggregates order amounts by customer",
      "Filters customers based on a total spend threshold"
    ],
    "business_logic": "Customers are defined as 'top' if their cumulative order amount exceeds 10,000.",
    "dependencies": [
      "analytics.sales_orders"
    ],
    "file_name": "vw_top_customers.sql",
    "file_type": "view",
    "file_path": "sql/views/vw_top_customers.sql"
  },
  {
    "purpose": "Creates or replaces a cleaned sales table in the staging schema by transforming and filtering data from the raw sales table.",
    "source_tables": [
      "raw.sales"
    ],
    "target_tables": [
      "staging.sales_clean"
    ],
    "transformations": [
      "Casting order_date to DATE using TRY_CAST",
      "Casting price to NUMBER(10,2) using TRY_CAST",
      "Filtering out records where order_id is NULL",
      "Filtering out records where quantity is not greater than 0"
    ],
    "business_logic": "Ensures data quality by including only records with a valid order ID and positive quantity, and standardizes data types for order date and price.",
    "dependencies": [
      "raw.sales"
    ],
    "file_name": "ctas_create_sales_clean.sql",
    "file_type": "script",
    "file_path": "sql/etl/ctas_create_sales_clean.sql"
  },
  {
    "purpose": "This SQL script enriches individual sales order records by joining them with customer and product information and calculating the total order amount per line item.",
    "source_tables": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "target_tables": [],
    "transformations": [
      "Joins raw.orders with raw.customers on customer_id and raw.products on product_id using LEFT JOINs.",
      "Calculates 'order_amount' as the product of 'quantity' and 'price' for each order line."
    ],
    "business_logic": "Enriches order details with corresponding customer region, product category, and product name, and computes the extended price for each order item.",
    "dependencies": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "file_name": "sales_enriched_pipeline.sql",
    "file_type": "script",
    "file_path": "sql/etl/sales_enriched_pipeline.sql"
  }
]