[
  {
    "purpose": "This SQL stored procedure updates or inserts customer lifetime value and order counts into a customer scores table.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.customer_scores"
    ],
    "transformations": [
      "Calculates lifetime_value by summing order_amount per customer_id",
      "Calculates order_count by counting orders per customer_id",
      "Merges calculated scores into the target table, updating existing records or inserting new ones"
    ],
    "business_logic": "Customer scores, including lifetime value and order count, are derived from sales order data and maintained in a dedicated analytics table.",
    "dependencies": [
      "analytics.sales_orders",
      "analytics.customer_scores"
    ],
    "file_name": "sp_update_customer_scores.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_update_customer_scores.sql"
  },
  {
    "purpose": "This procedure truncates and repopulates the `analytics.daily_sales` table with sales order data from the staging area.",
    "source_tables": [
      "staging.sales_orders"
    ],
    "target_tables": [
      "analytics.daily_sales"
    ],
    "transformations": [
      "Calculates 'order_amount' by multiplying 'quantity' and 'price'."
    ],
    "business_logic": "Populates the daily sales aggregate table by calculating the total amount for each sales record.",
    "dependencies": [
      "staging.sales_orders",
      "analytics.daily_sales"
    ],
    "file_name": "sp_refresh_daily_sales.sql",
    "file_type": "stored_procedure",
    "file_path": "sql/stored_procedures/sp_refresh_daily_sales.sql"
  },
  {
    "purpose": "This SQL model creates an enriched sales orders dataset by combining raw order details with product category information.",
    "source_tables": [
      "raw.orders",
      "dim_products"
    ],
    "target_tables": [
      "sales_orders"
    ],
    "transformations": [
      "Joins raw order data with product dimension data based on product_id",
      "Calculates the total order amount (quantity * price)",
      "Selects specific columns: order_id, customer_id, order_date, quantity, price, category, sub_category, and order_amount"
    ],
    "business_logic": "Combines transactional order line item data with static product attributes to provide a comprehensive view of sales orders, including product categories and calculated total order value.",
    "dependencies": [
      "raw.orders",
      "dim_products"
    ],
    "file_name": "sales_orders.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/sales_orders.sql"
  },
  {
    "purpose": "Creates a dimension table named `dim_products` by selecting core product attributes from the raw `products` source table.",
    "source_tables": [
      "raw.products"
    ],
    "target_tables": [
      "dim_products"
    ],
    "transformations": [
      "Direct column selection for product_id, product_name, category, sub_category, and list_price."
    ],
    "business_logic": "Extracts raw product attributes directly for dimensional modeling without additional filtering or complex calculations.",
    "dependencies": [
      "source('raw', 'products')"
    ],
    "file_name": "dim_products.sql",
    "file_type": "model",
    "file_path": "sql/dbt_models/dim_products.sql"
  },
  {
    "purpose": "Aggregates customer order data and joins it with customer details to create a summary table.",
    "source_tables": [
      "sales_orders",
      "raw.customers"
    ],
    "target_tables": [
      "customer_summary"
    ],
    "transformations": [
      "Calculates total revenue (SUM(quantity * price)) and total orders (COUNT(*)) per customer from sales data.",
      "Selects customer details (id, first_name, last_name, region).",
      "Performs a LEFT JOIN between customer details and aggregated order data on customer_id."
    ],
    "business_logic": "Combines individual customer data with their aggregated sales performance metrics (total revenue and total orders).",
    "dependencies": [
      "sales_orders",
      "raw.customers"
    ],
    "file_name": "customer_summary.sql",
    "file_type": "script",
    "file_path": "sql/dbt_models/customer_summary.sql"
  },
  {
    "purpose": "Creates a view identifying customers and their total spending, filtering for those who have spent more than 10,000.",
    "source_tables": [
      "analytics.sales_orders"
    ],
    "target_tables": [
      "analytics.vw_top_customers"
    ],
    "transformations": [
      "Aggregates order amounts to calculate total spend per customer",
      "Filters customers based on their aggregated total spend"
    ],
    "business_logic": "Defines 'top customers' as those whose cumulative order amount exceeds 10,000.",
    "dependencies": [
      "analytics.sales_orders"
    ],
    "file_name": "vw_top_customers.sql",
    "file_type": "view",
    "file_path": "sql/views/vw_top_customers.sql"
  },
  {
    "purpose": "Creates or replaces a cleaned sales dataset in the staging schema by selecting and transforming data from the raw sales table.",
    "source_tables": [
      "raw.sales"
    ],
    "target_tables": [
      "staging.sales_clean"
    ],
    "transformations": [
      "Casts 'order_date' to DATE using TRY_CAST",
      "Casts 'price' to NUMBER(10,2) using TRY_CAST"
    ],
    "business_logic": "Filters out records where 'order_id' is null or 'quantity' is not positive.",
    "dependencies": [
      "raw.sales"
    ],
    "file_name": "ctas_create_sales_clean.sql",
    "file_type": "script",
    "file_path": "sql/etl/ctas_create_sales_clean.sql"
  },
  {
    "purpose": "Enriches raw order data by integrating customer and product information and calculating the total amount for each order line.",
    "source_tables": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "target_tables": [],
    "transformations": [
      "Joins raw.orders with raw.customers on customer_id to add customer region.",
      "Joins raw.orders with raw.products on product_id to add product category and name.",
      "Calculates order_amount by multiplying quantity and price."
    ],
    "business_logic": "Combines transactional order details with customer demographics and product attributes to create a comprehensive sales record per order line item, including a computed monetary value.",
    "dependencies": [
      "raw.orders",
      "raw.customers",
      "raw.products"
    ],
    "file_name": "sales_enriched_pipeline.sql",
    "file_type": "script",
    "file_path": "sql/etl/sales_enriched_pipeline.sql"
  }
]